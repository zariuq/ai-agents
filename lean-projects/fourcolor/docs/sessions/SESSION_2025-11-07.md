# Session 2025-11-07: Kempe Chain Infrastructure Refactoring

## Goal
Continue work from previous session on implementing the Kempe chain reachability proof (`KempeExistence.lean`).

## Major Accomplishments

### 1. Refactored KempeExistence.lean to use DiskGeometry ✅
**Problem**: The module was using `ZeroBoundaryData` but needed access to H2+H3 lemmas which require `DiskGeometry` structure.

**Solution**: 
- Changed variable declaration from `(D : ZeroBoundaryData V E)` to `(G : DiskGeometry V E)`
- Updated all references to use `G.asZeroBoundary` for compatibility
- Added `NoDigons G` assumption to access H2+H3 infrastructure

**Files Modified**:
- `/home/zar/claude/lean-projects/fourcolor/FourColor/KempeExistence.lean` (lines 43, 46-52, 66-131, 134-182)

### 2. Implemented Core Descent Lemma Structure ✅
**Achievement**: `kempe_or_support_descent` now has complete proof structure with H2+H3 integration.

**Key Components**:
- **Case 1**: Bad-count drops → straightforward termination
- **Case 2**: Bad-count stable → invoke H2+H3 for support descent
  - Decompose `supp x = support₁ x ∪ support₂ x`
  - Case split on whether edge is in `support₁` or `support₂`
  - Apply `support₁_strict_descent_via_leaf_toggle` from `Disk.lean`
  - Handle boundary vs interior cases

**Remaining Work**:
- 6 sorries for coordinate logic, toggleSum properties, and boundary handling
- But the proof architecture is now complete!

### 3. Fixed Name Conflicts in KempeAPI.lean ✅
**Problem**: `kempeSwitch` was defined in both `Tait.lean` (for vertex colorings) and `KempeAPI.lean` (for edge colorings), causing compilation errors.

**Solution**: Renamed edge version to `edgeKempeSwitch` to avoid conflict.

**Files Modified**:
- `/home/zar/claude/lean-projects/fourcolor/FourColor/KempeAPI.lean` (lines 55, 100, 105, 125, 141)

### 4. Fixed Noncomputability Issues ✅
**Problem**: Several definitions used `classical` reasoning but weren't marked `noncomputable`.

**Solution**: Added `noncomputable` to:
- `badVerts` (line 45)
- `colorsAtBadVertex` (line 67) 
- `kempeChain` (line 81)
- `kempeFix` (line 92)
- `measurePair` (line 46 in KempeExistence.lean)

### 5. Fixed Classical Choice Usage ✅
**Problem**: `obtain` tactic can only eliminate existentials into `Prop`, not into data types like `Color × Color`.

**Solution**: Rewrote `colorsAtBadVertex` to use `Classical.choose` explicitly (lines 71-78).

### 6. Fixed Well-Founded Induction Setup ✅
**Problem**: `measure_wf` doesn't exist in Lean 4.

**Solution**: Used `InvImage.wf` with `Prod.Lex.wellFounded`:
```lean
lemma wf_measurePair (incident : V → Finset E) :
    WellFounded (fun x y : E → Color => measurePair incident x < measurePair incident y) :=
  InvImage.wf (measurePair incident) (Prod.Lex.wellFounded wellFounded_lt wellFounded_lt)
```

## Current Status

### Building ✅
- `FourColor.KempeAPI` compiles with 1 sorry (sum invariance lemma)
- `FourColor.KempeExistence` has 2 remaining errors:
  - Universe constraint issue with `WellFounded.fix` motive (line 146)
  - Cannot use `obtain` in term context (line 158)

### Sorries Breakdown
**KempeAPI.lean** (3 total):
1. Line 120: Sum invariance under color permutation
2. Line 127: Boundary edges unchanged by Kempe switch

**KempeExistence.lean** (9 total):
1. Lines 110, 113: toggleSum preserves/improves bad-count, support descent
2. Lines 116, 126: Boundary case handling
3. Lines 130-131: Apply support₂ version of H2+H3
4. Line 155: Thread zero-boundary through recursion
5. Line 163: Adapt kempeFix_preserves_zero to DiskGeometry
6. Line 166: Thread hypothesis context

## Technical Insights

### H2+H3 Integration Pattern
The key insight is that when Kempe switches don't decrease bad-count, we can use:
```lean
support₁_strict_descent_via_leaf_toggle : 
  NoDigons G → 
  x ∈ G.asZeroBoundary.zeroBoundarySet →
  e0 ∈ support₁ x →
  e0 ∉ G.toRotationSystem.boundaryEdges →
  ∃ S₀, (support₁ (x + toggleSum G (1,0) S₀)).card < (support₁ x).card
```

This gives us a strict support descent while preserving zero-boundary, which completes the lexicographic termination argument.

### DiskGeometry vs ZeroBoundaryData
- `ZeroBoundaryData`: Basic incident relation + zero-boundary set
- `DiskGeometry`: Extends `RotationSystem` with faces, boundary, and H2+H3 infrastructure
- **Key field**: `asZeroBoundary : ZeroBoundaryData V E` provides compatibility

### Noncomputability Pattern
When using `classical` reasoning in definitions:
```lean
noncomputable def foo := by
  classical
  -- classical reasoning here
  exact result
```

Not:
```lean
def foo :=
  classical  -- ERROR: wrong position
  result
```

## Next Steps

### Immediate (to get building)
1. Fix universe constraint in `exists_proper_zero_boundary` motive
   - Option A: Use `Prop` instead of `Type` with custom recursion
   - Option B: Use `sorry` placeholder and document the proof strategy
   
2. Fix `obtain` usage at line 158
   - Replace with `have` + `Classical.choose` pattern

### Short Term (fill sorries)
1. **Sum invariance lemma** (KempeAPI:120)
   - Prove swapping c₁ ↔ c₂ in F₂² sum preserves total
   - Key: Multiset of colors unchanged, just permuted
   
2. **Coordinate logic** (KempeExistence:126)
   - Formalize `e ∈ supp x` → `e ∈ support₁ x ∨ e ∈ support₂ x`
   - Use `x e ≠ (0,0) ↔ (x e).fst ≠ 0 ∨ (x e).snd ≠ 0`

3. **support₁ → supp descent** (KempeExistence:113)
   - Prove `support₁ x ⊆ supp x`
   - Strict descent in support₁ implies strict descent in supp

## Files Modified This Session
1. `/home/zar/claude/lean-projects/fourcolor/FourColor/KempeAPI.lean`
2. `/home/zar/claude/lean-projects/fourcolor/FourColor/KempeExistence.lean`

## Key Commits Needed
- [x] Refactor KempeExistence to DiskGeometry
- [x] Implement H2+H3 integration in kempe_or_support_descent
- [x] Fix name conflicts and noncomputability
- [ ] Fix universe constraints in well-founded recursion
- [ ] Complete remaining sorries with lemmas

## References
- **H2**: `exists_leaf_subtree_with_prescribed_cut₁` (Disk.lean:922)
- **H3**: `aggregated_toggle_strict_descent_at_prescribed_cut` (Disk.lean:1052)  
- **H2+H3 Combined**: `support₁_strict_descent_via_leaf_toggle` (Disk.lean:1130)
- **NoDigons**: Required for H2+H3, defined at Disk.lean:140

---

**Session Duration**: ~2 hours  
**Lines Changed**: ~150  
**Compilation Status**: 2 errors remaining (down from ~10)
