# H2/H3 Aggregated Peels Session - 2025-11-04

**Goal**: Complete H2/H3 pipeline using aggregated peel approach (`LeafPeelSumData.peel_sum`)

---

## Progress Summary

### Completed ‚úÖ
1. **H3 Strict Descent - Core Structure** (lines 579-637)
   - Successfully applied `support‚ÇÅ_add_toggles_singleton` lemma (from cleanup patches)
   - Extracted `S‚ÇÄ ‚äÜ internalFaces` from `S‚ÇÄ ‚äÜ facesTouching‚ÇÅ`
   - Handled boundary edges case (toggleSum = 0 for boundary edges)
   - Handled internal edges in support‚ÇÅ case (uses `toggleSum_supported_on_cuts‚ÇÅ_10`)
   - Completed the second goal showing `(toggleSum e‚ÇÄ).fst ‚â† 0`

### In Progress ‚ö†Ô∏è
2. **H3 Strict Descent - One Remaining Sorry** (line 632)
   - **Issue**: Need to show that if `e ‚àâ support‚ÇÅ x` and `e ‚â† e0`, then `(toggleSum e).fst = 0`
   - **Blocker**: Requires helper lemma about relationship between `cutEdges` and `cutEdges‚ÇÅ`

   **Required Helper Lemma**:
   ```lean
   lemma cutEdges_of_facesTouching‚ÇÅ_subset_support‚ÇÅ
       {S‚ÇÄ : Finset (Finset E)} (hS‚ÇÄ : S‚ÇÄ ‚äÜ facesTouching‚ÇÅ G x)
       (e : E) (he_internal : e ‚àâ G.toRotationSystem.boundaryEdges) :
       e ‚àà cutEdges G S‚ÇÄ ‚Üí e ‚àà support‚ÇÅ x :=
   ```

   **Proof Strategy**: Since faces in `facesTouching‚ÇÅ` only touch edges in `support‚ÇÅ x`,
   any cut edge (edge in exactly one face of S‚ÇÄ) must be in `support‚ÇÅ x` (or boundary, which is excluded).

### Pending üìã
3. **H2 Prescribed Cut Existence** (line 566)
   - **Status**: Marked as `sorry` with note "Implementation moved after helper definitions"
   - **Dependencies**: Requires graph theory about spanning forest and leaf-finding
   - **Complexity**: ~146 lines of standard graph theory (per PROOF_ARCHITECTURE.md)

4. **Meridian Layer Sorries** (lines 841, 847)
   - Two sorries in `faceBoundaryChainRel_dot_incident_sum` related to parity
   - **Line 841**: Sum manipulation with boundary edge filtering
   - **Line 847**: Even parity transfer through filter
   - **Complexity**: ~73 lines (per PROOF_ARCHITECTURE.md)

---

## H2/H3 Integration Status

### Current Architecture
- **H2**: `prescribed_cut_existence_10` - finds leaf-subtree with unique cut edge
- **H3**: `aggregated_toggle_strict_descent_at_prescribed_cut‚ÇÅ` - proves strict descent
- **Integration**: These compose to give `LeafPeelSumData.peel_sum` implementation

### Remaining Work
1. **Helper Lemma** (`cutEdges_of_facesTouching‚ÇÅ_subset_support‚ÇÅ`) - ~10 lines
2. **H2 Implementation** - ~146 lines of graph theory (spanning forest + leaf finding)
3. **Meridian Sorries** - ~73 lines (parity + boundary handling)
4. **Integration Verification** - Connect to `LeafPeelSumData`

**Total Estimated**: ~230 lines of mathematics

---

## Key Insights

1. **Aggregated Peels Work Well**: The `LeafPeelSumData` approach with `toggleSum` is clean and composable

2. **Support-Aware Cuts Critical**: The distinction between `cutEdges` (all cut edges) and `cutEdges‚ÇÅ` (cut edges in `support‚ÇÅ`) is essential for strict descent

3. **Boundary Handling**: Many cases split on `e ‚àà boundaryEdges` - boundary edges have simpler behavior (toggleSum = 0)

4. **Graph Theory Remaining**: The main blockers are standard graph theory facts about:
   - Spanning forests and leaf existence
   - Cut edge properties in face adjacency graphs
   - Parity facts about face-vertex incidence

---

## Next Steps

1. Add helper lemma `cutEdges_of_facesTouching‚ÇÅ_subset_support‚ÇÅ` (10 lines)
2. Complete H3 using the helper lemma (remove line 632 sorry)
3. Implement H2 `prescribed_cut_existence_10` (graph theory)
4. Complete meridian layer sorries (parity + boundary)
5. Verify integration with `LeafPeelSumData.peel_sum`

---

**Session Status**: H3 is 90% complete, blocked on one graph theory helper lemma.
The overall H2/H3 pipeline architecture is sound and aligns well with Goertzel v3.
